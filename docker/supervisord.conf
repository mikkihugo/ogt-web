[supervisord]
nodaemon=true
logfile=/dev/stdout
logfile_maxbytes=0
pidfile=/run/supervisord.pid
# Run supervisord as root to manage services, but services run as unprivileged users
# NOTE: Ensure all specified users below exist in the container (redis, mysql, caddy, nobody, www-data)

[program:redis]
command=redis-server --port 6379 --loglevel warning --dir /var/lib/mysql/redis --dbfilename dump.rdb
autostart=true
autorestart=true
user=redis
stdout_logfile=/dev/stdout
stdout_logfile_maxbytes=0
stderr_logfile=/dev/stderr
stderr_logfile_maxbytes=0
# Robust startup: wait 5 seconds before considering service started
startsecs=5
# Run as redis user for least privilege

[program:opensearch]
command=/opt/opensearch/bin/opensearch
autostart=true
autorestart=true
user=opensearch
environment=JAVA_HOME="/usr/lib/jvm/java-17-openjdk",OPENSEARCH_JAVA_OPTS="-Xms512m -Xmx512m"
stdout_logfile=/dev/stdout
stdout_logfile_maxbytes=0
stderr_logfile=/dev/stderr
stderr_logfile_maxbytes=0
# OpenSearch takes longer to start
startsecs=30
# Run as opensearch user for least privilege

[program:mariadb]
command=/usr/bin/mysqld --datadir=/var/lib/mysql --socket=/run/mysqld/mysqld.sock --user=mysql
autostart=true
autorestart=true
stdout_logfile=/dev/stdout
stdout_logfile_maxbytes=0
stderr_logfile=/dev/stderr
stderr_logfile_maxbytes=0
# Robust startup: wait 5 seconds before considering service started
startsecs=5
# MariaDB already specifies --user=mysql internally

[program:php-fpm]
command=php-fpm -F
autostart=true
autorestart=true
stdout_logfile=/dev/stdout
stdout_logfile_maxbytes=0
stderr_logfile=/dev/stderr
stderr_logfile_maxbytes=0
# Robust startup: wait 5 seconds before considering service started
startsecs=5
# PHP-FPM runs with user/group specified in php-fpm.conf (typically www-data)

[program:caddy]
command=caddy run --config /etc/caddy/Caddyfile --adapter caddyfile
autostart=true
autorestart=true
user=caddy
stdout_logfile=/dev/stdout
stdout_logfile_maxbytes=0
stderr_logfile=/dev/stderr
stderr_logfile_maxbytes=0
# Robust startup: wait 5 seconds before considering service started
startsecs=5
# Run as caddy user for least privilege

[program:mysqld_exporter]
command=mysqld_exporter --config.my-cnf /etc/.mysqld_exporter.cnf --web.listen-address="0.0.0.0:9104"
autostart=true
autorestart=true
user=nobody
stdout_logfile=/dev/stdout
stdout_logfile_maxbytes=0
stderr_logfile=/dev/stderr
stderr_logfile_maxbytes=0
# Robust startup: wait 5 seconds before considering service started
startsecs=5
# NOTE: Ensure /etc/.mysqld_exporter.cnf exists and is readable by nobody
# Run as nobody user - read-only access to MySQL
# Bind to localhost only - not exposed externally

[program:redis_exporter]
command=redis_exporter --redis.addr localhost:6379 --web.listen-address="0.0.0.0:9121"
autostart=true
autorestart=true
user=nobody
stdout_logfile=/dev/stdout
stdout_logfile_maxbytes=0
stderr_logfile=/dev/stderr
stderr_logfile_maxbytes=0
# Robust startup: wait 5 seconds before considering service started
startsecs=5
# NOTE: Ensure redis_exporter can connect to Redis on localhost:6379
# Run as nobody user - read-only access to Redis
# Bind to localhost only - not exposed externally

[program:php-fpm_exporter]
command=php-fpm_exporter server --phpfpm.scrape-uri unix:///run/php-fpm.sock --web.listen-address="0.0.0.0:9253"
autostart=true
autorestart=true
user=www-data
stdout_logfile=/dev/stdout
stdout_logfile_maxbytes=0
stderr_logfile=/dev/stderr
stderr_logfile_maxbytes=0
# Robust startup: wait 5 seconds before considering service started
startsecs=5
# NOTE: Ensure unix:///run/php-fpm.sock matches actual PHP-FPM socket path and is accessible by www-data
# Run as www-data to access PHP-FPM socket
# Bind to localhost only - not exposed externally
