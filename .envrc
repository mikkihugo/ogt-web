# Enforce Nix + flake-based devshell for this repo
if ! command -v nix >/dev/null 2>&1; then
  echo "Nix is required for the ogt-web devshell. Install nix first." >&2
  exit 1
fi

# If encrypted env exists, require the master key. Allow a local, gitignored
# .env.private to store DOTENV_PRIVATE_KEY=... for convenience on a dev box.
if [ -f .env.encrypted ]; then
  if [ -z "${DOTENV_PRIVATE_KEY:-}" ] && [ -f .env.private ]; then
    # shellcheck disable=SC1091
    source .env.private
  fi
  # Try Infisical (interactive login or service token)
  if [ -z "${DOTENV_PRIVATE_KEY:-}" ] && command -v infisical >/dev/null 2>&1; then
    INFISICAL_API_URL=${INFISICAL_API_URL:-https://vault.singularity-engine.com/api}
    TOKEN_ARGS=()
    if [ -n "${INFISICAL_SERVICE_TOKEN:-}" ]; then
      TOKEN_ARGS=(--token "${INFISICAL_SERVICE_TOKEN}")
    fi
    DOTENV_PRIVATE_KEY=$(INFISICAL_API_URL="$INFISICAL_API_URL" infisical secrets get DOTENV_PRIVATE_KEY --env prod --path /ogt-web --plain --silent "${TOKEN_ARGS[@]}" 2>/dev/null | head -n1 || true)
    export DOTENV_PRIVATE_KEY
  fi
  if [ -z "${DOTENV_PRIVATE_KEY:-}" ]; then
    cat <<'EOF' >&2
Missing DOTENV_PRIVATE_KEY for decrypting .env.encrypted.
- Run: infisical login --domain https://vault.singularity-engine.com
  then rerun your command (or set INFISICAL_SERVICE_TOKEN for non-interactive).
- Optional local override: create gitignored .env.private with DOTENV_PRIVATE_KEY=...
EOF
    exit 1
  fi
fi

use flake .
