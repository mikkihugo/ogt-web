---
import Layout from '../../layouts/Layout.astro';
import Header from '../../components/Header.astro';
import Footer from '../../components/Footer.astro';
import ProductCard from '../../components/ProductCard.astro';
import { medusaClient } from '../../lib/medusa';

// Get query parameters
const url = new URL(Astro.request.url);
const searchQuery = url.searchParams.get('q') || '';
const category = url.searchParams.get('category') || '';
const sort = url.searchParams.get('sort') || '';
const page = parseInt(url.searchParams.get('page') || '1', 10);
const limit = 12;
const offset = (page - 1) * limit;

// Fetch products
let products = [];
let totalCount = 0;
let error = null;

try {
  const params: any = { limit, offset };
  if (searchQuery) params.q = searchQuery;
  if (category) params.category_id = category;

  const response = await medusaClient.getProducts(params);
  products = response.products;
  totalCount = response.count;
} catch (e) {
  console.error('Error fetching products:', e);
  error = e instanceof Error ? e.message : 'Failed to load products';
}

const totalPages = Math.ceil(totalCount / limit);
---

<Layout title={`Shop ${category ? `- ${category}` : ''} | Orgasm Toy`}>
  <Header />

  <main class="min-h-screen bg-gray-50">
    <!-- Page Header -->
    <section class="bg-gradient-to-r from-rose-100 to-purple-100 py-12">
      <div class="container mx-auto px-4">
        <h1 class="text-4xl font-bold text-gray-900 mb-4">
          {category ? category.charAt(0).toUpperCase() + category.slice(1) : 'All Products'}
        </h1>
        <p class="text-gray-600">
          {searchQuery ? `Search results for "${searchQuery}"` : 'Discover our curated collection of wellness products'}
        </p>
      </div>
    </section>

    <div class="container mx-auto px-4 py-8">
      <div class="flex flex-col lg:flex-row gap-8">
        <!-- Filters Sidebar -->
        <aside class="lg:w-64 flex-shrink-0">
          <div class="bg-white rounded-lg shadow-sm p-6 sticky top-24">
            <h2 class="font-bold text-lg mb-4">Filters</h2>

            <!-- Search -->
            <div class="mb-6">
              <label for="search" class="block text-sm font-medium text-gray-700 mb-2">
                Search
              </label>
              <form method="get" action="/shop">
                <input
                  type="text"
                  id="search"
                  name="q"
                  value={searchQuery}
                  placeholder="Search products..."
                  class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-rose-500 focus:border-transparent"
                />
                <button
                  type="submit"
                  class="w-full mt-2 bg-rose-600 text-white px-4 py-2 rounded-lg hover:bg-rose-700 transition"
                >
                  Search
                </button>
              </form>
            </div>

            <!-- Categories -->
            <div class="mb-6">
              <h3 class="text-sm font-medium text-gray-700 mb-3">Categories</h3>
              <ul class="space-y-2">
                <li>
                  <a
                    href="/shop"
                    class={`block text-sm hover:text-rose-600 transition ${!category ? 'text-rose-600 font-medium' : 'text-gray-600'}`}
                  >
                    All Products
                  </a>
                </li>
                <li>
                  <a
                    href="/shop?category=couples"
                    class={`block text-sm hover:text-rose-600 transition ${category === 'couples' ? 'text-rose-600 font-medium' : 'text-gray-600'}`}
                  >
                    Couples
                  </a>
                </li>
                <li>
                  <a
                    href="/shop?category=self-care"
                    class={`block text-sm hover:text-rose-600 transition ${category === 'self-care' ? 'text-rose-600 font-medium' : 'text-gray-600'}`}
                  >
                    Self-Care
                  </a>
                </li>
                <li>
                  <a
                    href="/shop?category=wellness"
                    class={`block text-sm hover:text-rose-600 transition ${category === 'wellness' ? 'text-rose-600 font-medium' : 'text-gray-600'}`}
                  >
                    Wellness
                  </a>
                </li>
              </ul>
            </div>

            <!-- Sort -->
            <div>
              <h3 class="text-sm font-medium text-gray-700 mb-3">Sort By</h3>
              <select
                id="sort-select"
                class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-rose-500 focus:border-transparent"
                onchange="window.location.href = '/shop?sort=' + this.value + (new URLSearchParams(window.location.search).get('category') ? '&category=' + new URLSearchParams(window.location.search).get('category') : '')"
              >
                <option value="">Featured</option>
                <option value="new" selected={sort === 'new'}>Newest</option>
                <option value="price-low" selected={sort === 'price-low'}>Price: Low to High</option>
                <option value="price-high" selected={sort === 'price-high'}>Price: High to Low</option>
              </select>
            </div>
          </div>
        </aside>

        <!-- Products Grid -->
        <div class="flex-1">
          {error ? (
            <div class="bg-red-50 border border-red-200 text-red-800 px-6 py-4 rounded-lg">
              <p class="font-medium">Unable to load products</p>
              <p class="text-sm mt-1">{error}</p>
              <p class="text-sm mt-2">
                Make sure the Medusa backend is running and PUBLIC_MEDUSA_BACKEND_URL is configured.
              </p>
            </div>
          ) : products.length > 0 ? (
            <>
              <div class="mb-4 flex items-center justify-between">
                <p class="text-gray-600">
                  Showing {offset + 1}-{Math.min(offset + limit, totalCount)} of {totalCount} products
                </p>
              </div>

              <div class="grid md:grid-cols-2 xl:grid-cols-3 gap-6 mb-8">
                {products.map((product) => (
                  <ProductCard product={product} />
                ))}
              </div>

              <!-- Pagination -->
              {totalPages > 1 && (
                <div class="flex justify-center gap-2">
                  {page > 1 && (
                    <a
                      href={`/shop?page=${page - 1}${category ? `&category=${category}` : ''}${searchQuery ? `&q=${searchQuery}` : ''}`}
                      class="px-4 py-2 border border-gray-300 rounded-lg hover:bg-gray-50 transition"
                    >
                      Previous
                    </a>
                  )}

                  {Array.from({ length: Math.min(5, totalPages) }, (_, i) => {
                    const pageNum = i + 1;
                    return (
                      <a
                        href={`/shop?page=${pageNum}${category ? `&category=${category}` : ''}${searchQuery ? `&q=${searchQuery}` : ''}`}
                        class={`px-4 py-2 border rounded-lg transition ${
                          pageNum === page
                            ? 'bg-rose-600 text-white border-rose-600'
                            : 'border-gray-300 hover:bg-gray-50'
                        }`}
                      >
                        {pageNum}
                      </a>
                    );
                  })}

                  {page < totalPages && (
                    <a
                      href={`/shop?page=${page + 1}${category ? `&category=${category}` : ''}${searchQuery ? `&q=${searchQuery}` : ''}`}
                      class="px-4 py-2 border border-gray-300 rounded-lg hover:bg-gray-50 transition"
                    >
                      Next
                    </a>
                  )}
                </div>
              )}
            </>
          ) : (
            <div class="text-center py-12 bg-white rounded-lg shadow-sm">
              <svg
                class="w-16 h-16 text-gray-400 mx-auto mb-4"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M20 13V6a2 2 0 00-2-2H6a2 2 0 00-2 2v7m16 0v5a2 2 0 01-2 2H6a2 2 0 01-2-2v-5m16 0h-2.586a1 1 0 00-.707.293l-2.414 2.414a1 1 0 01-.707.293h-3.172a1 1 0 01-.707-.293l-2.414-2.414A1 1 0 006.586 13H4"
                />
              </svg>
              <h3 class="text-lg font-medium text-gray-900 mb-2">No products found</h3>
              <p class="text-gray-600 mb-4">
                {searchQuery ? `No results for "${searchQuery}"` : 'Try adjusting your filters'}
              </p>
              <a href="/shop" class="text-rose-600 font-medium hover:underline">
                Clear filters
              </a>
            </div>
          )}
        </div>
      </div>
    </div>
  </main>

  <Footer />
</Layout>
