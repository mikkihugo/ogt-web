---
import Layout from '../../layouts/Layout.astro';
import Header from '../../components/Header.astro';
import Footer from '../../components/Footer.astro';
import ProductCard from '../../components/ProductCard.astro';
import { medusaClient, formatPrice, getProductImage } from '../../lib/medusa';
import type { MedusaProduct } from '../../lib/medusa';

export async function getStaticPaths() {
  // For SSR, return empty array
  return [];
}

const { handle } = Astro.params;

// Fetch product by handle
let product: MedusaProduct | null = null;
let relatedProducts: MedusaProduct[] = [];
let error = null;

try {
  // Fetch all products and find by handle
  const { products } = await medusaClient.getProducts({ limit: 100 });
  product = products.find((p) => p.handle === handle) || null;

  if (!product) {
    error = 'Product not found';
  } else {
    // Fetch related products from same collection
    if (product.collection) {
      const { products: collectionProducts } = await medusaClient.getProducts({
        collection_id: product.collection.id,
        limit: 4,
      });
      relatedProducts = collectionProducts.filter((p) => p.id !== product?.id).slice(0, 3);
    }
  }
} catch (e) {
  console.error('Error fetching product:', e);
  error = e instanceof Error ? e.message : 'Failed to load product';
}

if (!product && !error) {
  return Astro.redirect('/shop');
}

const mainImage = product ? getProductImage(product) : '';
const images = product?.images || [];
---

<Layout title={product ? `${product.title} | Orgasm Toy` : 'Product Not Found'}>
  <Header />

  <main class="min-h-screen bg-gray-50">
    {error || !product ? (
      <div class="container mx-auto px-4 py-16">
        <div class="max-w-md mx-auto text-center">
          <h1 class="text-3xl font-bold text-gray-900 mb-4">Product Not Found</h1>
          <p class="text-gray-600 mb-8">{error || 'The product you are looking for does not exist.'}</p>
          <a
            href="/shop"
            class="inline-block bg-rose-600 text-white px-8 py-3 rounded-full font-medium hover:bg-rose-700 transition"
          >
            Back to Shop
          </a>
        </div>
      </div>
    ) : (
      <>
        <!-- Breadcrumb -->
        <div class="bg-white border-b">
          <div class="container mx-auto px-4 py-4">
            <nav class="flex items-center gap-2 text-sm text-gray-600">
              <a href="/" class="hover:text-rose-600">Home</a>
              <span>/</span>
              <a href="/shop" class="hover:text-rose-600">Shop</a>
              {product.collection && (
                <>
                  <span>/</span>
                  <a href={`/shop?collection=${product.collection.id}`} class="hover:text-rose-600">
                    {product.collection.title}
                  </a>
                </>
              )}
              <span>/</span>
              <span class="text-gray-900">{product.title}</span>
            </nav>
          </div>
        </div>

        <!-- Product Details -->
        <div class="container mx-auto px-4 py-12">
          <div class="grid lg:grid-cols-2 gap-12 mb-16">
            <!-- Product Images -->
            <div>
              <div class="bg-white rounded-lg shadow-lg overflow-hidden mb-4">
                <img
                  id="main-image"
                  src={mainImage}
                  alt={product.title}
                  class="w-full h-auto object-cover"
                />
              </div>

              {images.length > 1 && (
                <div class="grid grid-cols-4 gap-2">
                  {images.map((image) => (
                    <button
                      class="image-thumbnail border-2 border-transparent hover:border-rose-600 rounded-lg overflow-hidden transition"
                      onclick={`document.getElementById('main-image').src = '${image.url}'`}
                    >
                      <img src={image.url} alt={product.title} class="w-full h-auto object-cover" />
                    </button>
                  ))}
                </div>
              )}
            </div>

            <!-- Product Info -->
            <div>
              {product.collection && (
                <p class="text-sm text-rose-600 font-medium uppercase tracking-wide mb-2">
                  {product.collection.title}
                </p>
              )}

              <h1 class="text-4xl font-bold text-gray-900 mb-4">{product.title}</h1>

              <div class="flex items-center gap-4 mb-6">
                <span class="text-3xl font-bold text-gray-900">
                  {formatPrice(product.variants?.[0]?.prices?.[0]?.amount || 0, product.variants?.[0]?.prices?.[0]?.currency_code)}
                </span>
                {product.tags?.some((tag) => tag.value.toLowerCase() === 'sale') && (
                  <span class="bg-purple-600 text-white text-sm font-bold px-3 py-1 rounded-full">
                    SALE
                  </span>
                )}
              </div>

              {product.description && (
                <div class="prose prose-gray mb-8">
                  <p class="text-gray-600 leading-relaxed">{product.description}</p>
                </div>
              )}

              <!-- Variant Selection -->
              {product.variants && product.variants.length > 1 && (
                <div class="mb-6">
                  <h3 class="text-sm font-medium text-gray-900 mb-3">Select Variant</h3>
                  <div class="grid grid-cols-2 gap-3">
                    {product.variants.map((variant, index) => (
                      <button
                        class={`variant-btn border-2 p-3 rounded-lg text-left transition ${
                          index === 0
                            ? 'border-rose-600 bg-rose-50'
                            : 'border-gray-300 hover:border-rose-600'
                        }`}
                        data-variant-id={variant.id}
                        data-price={variant.prices?.[0]?.amount}
                        data-currency={variant.prices?.[0]?.currency_code}
                        onclick="selectVariant(this)"
                      >
                        <div class="font-medium text-gray-900">{variant.title}</div>
                        {variant.prices?.[0] && (
                          <div class="text-sm text-gray-600">
                            {formatPrice(variant.prices[0].amount, variant.prices[0].currency_code)}
                          </div>
                        )}
                        {variant.inventory_quantity !== undefined && variant.inventory_quantity === 0 && (
                          <div class="text-xs text-red-600 mt-1">Out of stock</div>
                        )}
                      </button>
                    ))}
                  </div>
                </div>
              )}

              <!-- Quantity Selector -->
              <div class="mb-8">
                <label for="quantity" class="block text-sm font-medium text-gray-900 mb-3">
                  Quantity
                </label>
                <div class="flex items-center gap-3">
                  <button
                    onclick="updateQuantity(-1)"
                    class="w-10 h-10 border border-gray-300 rounded-lg hover:bg-gray-50 transition flex items-center justify-center"
                  >
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 12H4" />
                    </svg>
                  </button>
                  <input
                    type="number"
                    id="quantity"
                    value="1"
                    min="1"
                    max="10"
                    class="w-20 text-center border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-rose-500 focus:border-transparent"
                  />
                  <button
                    onclick="updateQuantity(1)"
                    class="w-10 h-10 border border-gray-300 rounded-lg hover:bg-gray-50 transition flex items-center justify-center"
                  >
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
                    </svg>
                  </button>
                </div>
              </div>

              <!-- Add to Cart Button -->
              <button
                id="add-to-cart-btn"
                class="w-full bg-rose-600 text-white px-8 py-4 rounded-full font-medium hover:bg-rose-700 transition shadow-lg hover:shadow-xl mb-4"
                onclick="addToCart()"
              >
                Add to Cart
              </button>

              <!-- Product Features -->
              <div class="border-t pt-8 space-y-4">
                <div class="flex items-start gap-3">
                  <svg class="w-6 h-6 text-rose-600 flex-shrink-0 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z" />
                  </svg>
                  <div>
                    <h4 class="font-medium text-gray-900">Body-Safe Materials</h4>
                    <p class="text-sm text-gray-600">Premium, non-toxic materials for your safety</p>
                  </div>
                </div>

                <div class="flex items-start gap-3">
                  <svg class="w-6 h-6 text-rose-600 flex-shrink-0 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4" />
                  </svg>
                  <div>
                    <h4 class="font-medium text-gray-900">Discreet Shipping</h4>
                    <p class="text-sm text-gray-600">Plain packaging, no product names</p>
                  </div>
                </div>

                <div class="flex items-start gap-3">
                  <svg class="w-6 h-6 text-rose-600 flex-shrink-0 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
                  </svg>
                  <div>
                    <h4 class="font-medium text-gray-900">Easy Returns</h4>
                    <p class="text-sm text-gray-600">30-day return policy on unopened items</p>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Related Products -->
          {relatedProducts.length > 0 && (
            <div class="border-t pt-16">
              <h2 class="text-3xl font-bold mb-8">You May Also Like</h2>
              <div class="grid md:grid-cols-2 lg:grid-cols-3 gap-6">
                {relatedProducts.map((relatedProduct) => (
                  <ProductCard product={relatedProduct} />
                ))}
              </div>
            </div>
          )}
        </div>
      </>
    )}
  </main>

  <Footer />

  <script is:inline define:vars={{ productTitle: product?.title, productId: product?.id, productImage: mainImage }}>
    let selectedVariantId = document.querySelector('.variant-btn')?.dataset?.variantId || '';

    function selectVariant(btn) {
      // Update selected state
      document.querySelectorAll('.variant-btn').forEach((b) => {
        b.classList.remove('border-rose-600', 'bg-rose-50');
        b.classList.add('border-gray-300');
      });
      btn.classList.remove('border-gray-300');
      btn.classList.add('border-rose-600', 'bg-rose-50');

      // Update selected variant
      selectedVariantId = btn.dataset.variantId;

      // Update price display
      const price = btn.dataset.price;
      const currency = btn.dataset.currency;
      if (price && currency) {
        const formatted = new Intl.NumberFormat('en-US', {
          style: 'currency',
          currency: currency.toUpperCase(),
        }).format(parseInt(price) / 100);

        document.querySelector('.text-3xl.font-bold.text-gray-900').textContent = formatted;
      }
    }

    function updateQuantity(delta) {
      const input = document.getElementById('quantity');
      const currentValue = parseInt(input.value) || 1;
      const newValue = Math.max(1, Math.min(10, currentValue + delta));
      input.value = newValue;
    }

    async function addToCart() {
      const quantity = parseInt(document.getElementById('quantity').value) || 1;
      const variantId = selectedVariantId || document.querySelector('.variant-btn')?.dataset?.variantId;

      if (!variantId) {
        alert('Please select a variant');
        return;
      }

      const btn = document.getElementById('add-to-cart-btn');
      const originalText = btn.textContent;
      btn.disabled = true;
      btn.textContent = 'Adding...';

      try {
        // Get variant price
        const variantBtn = document.querySelector(`[data-variant-id="${variantId}"]`);
        const price = parseInt(variantBtn?.dataset?.price || '0');

        // Add to local storage cart
        const cartData = localStorage.getItem('cart-storage');
        const cart = cartData ? JSON.parse(cartData) : { items: [] };

        const existingItemIndex = cart.items.findIndex((item) => item.variantId === variantId);

        if (existingItemIndex > -1) {
          cart.items[existingItemIndex].quantity += quantity;
        } else {
          cart.items.push({
            id: `item_${Date.now()}_${Math.random().toString(36).substring(7)}`,
            variantId: variantId,
            productId: productId,
            title: productTitle,
            variantTitle: variantBtn?.querySelector('.font-medium')?.textContent || '',
            quantity: quantity,
            price: price,
            image: productImage,
          });
        }

        localStorage.setItem('cart-storage', JSON.stringify(cart));

        // Dispatch event to update cart count
        window.dispatchEvent(new CustomEvent('cart-updated'));

        btn.textContent = 'Added!';
        btn.classList.remove('bg-rose-600', 'hover:bg-rose-700');
        btn.classList.add('bg-green-600');

        setTimeout(() => {
          btn.textContent = originalText;
          btn.classList.remove('bg-green-600');
          btn.classList.add('bg-rose-600', 'hover:bg-rose-700');
          btn.disabled = false;
        }, 2000);
      } catch (error) {
        console.error('Error adding to cart:', error);
        btn.textContent = 'Error - Try Again';
        btn.classList.remove('bg-rose-600');
        btn.classList.add('bg-red-600');

        setTimeout(() => {
          btn.textContent = originalText;
          btn.classList.remove('bg-red-600');
          btn.classList.add('bg-rose-600');
          btn.disabled = false;
        }, 2000);
      }
    }
  </script>
</Layout>
