# =============================================================================
# FlakeCache nix-csi Configuration
# =============================================================================
#
# PURPOSE:
# Centralized Nix configuration for all nix-csi components. These ConfigMaps
# define binary cache sources, trusted keys, and Nix behavior settings.
#
# CONFIGURATION OPTIONS EXPLAINED:
#
# ┌─────────────────────────────────────────────────────────────────────────┐
# │                      Nix Configuration Reference                         │
# ├─────────────────────────────────────────────────────────────────────────┤
# │                                                                          │
# │  experimental-features = nix-command flakes                             │
# │  └── Enables: nix build, nix develop, nix flake, etc.                   │
# │                                                                          │
# │  substituters = https://cache.nixos.org http://attic...                 │
# │  └── Binary caches to pull pre-built packages from                      │
# │      Order matters: first cache checked first                           │
# │                                                                          │
# │  trusted-public-keys = cache.nixos.org-1:... singularity:...            │
# │  └── Ed25519 public keys for signature verification                     │
# │      Format: name:base64-encoded-key                                    │
# │                                                                          │
# │  require-sigs = true                                                    │
# │  └── CRITICAL: Only accept signed store paths                           │
# │      Prevents supply chain attacks via unsigned packages                │
# │                                                                          │
# │  max-jobs = auto                                                        │
# │  └── Parallel build jobs = number of CPU cores                          │
# │                                                                          │
# │  keep-outputs = true                                                    │
# │  └── Keep build outputs (not just runtime deps)                         │
# │      Useful for development and debugging                               │
# │                                                                          │
# │  builders-use-substitutes = true                                        │
# │  └── Remote builders can pull from binary caches                        │
# │      Reduces data transfer between builder and client                   │
# │                                                                          │
# └─────────────────────────────────────────────────────────────────────────┘
#
# BINARY CACHE ARCHITECTURE:
#
#   ┌──────────────┐     ┌──────────────────┐     ┌──────────────────┐
#   │ nixos.org    │     │ Attic (private)  │     │ FlakeCache       │
#   │ Public cache │     │ Internal cache   │     │ (future)         │
#   └──────┬───────┘     └────────┬─────────┘     └────────┬─────────┘
#          │                      │                        │
#          │    HTTPS + Signed    │    HTTP (internal)     │
#          │                      │                        │
#          └──────────────────────┼────────────────────────┘
#                                 │
#                                 ▼
#                    ┌────────────────────────┐
#                    │     nix-daemon         │
#                    │  require-sigs = true   │
#                    │  Verifies signatures   │
#                    └────────────────────────┘
#
# SECURITY MODEL:
# 1. All store paths must be signed by a trusted key
# 2. Keys are Ed25519 for strong cryptographic security
# 3. Attic cache uses internal DNS (no external exposure)
# 4. Public cache (nixos.org) uses HTTPS
#
# THREE CONFIGS PROVIDED:
#
# 1. nix-csi-config: Full config with Attic + community caches
#    - Used by: nix-daemon DaemonSet, nix-node CSI pods
#    - Includes: nixos.org, Cachix (nix-community), Determinate Systems, Attic
#
# 2. nix-cache-config: Minimal public-only config
#    - Used by: Standalone runners without Attic
#    - Only cache.nixos.org, simpler setup
#
# SUPPORTED BINARY CACHES:
#
# ┌────────────────────────────────────────────────────────────────────────┐
# │  Cache                    │ URL                       │ Purpose        │
# ├────────────────────────────────────────────────────────────────────────┤
# │  cache.nixos.org          │ https://cache.nixos.org   │ Official NixOS │
# │  nix-community (Cachix)   │ https://nix-community...  │ Community pkgs │
# │  Determinate Systems      │ https://cache.determinate │ Nix tooling    │
# │  Attic (internal)         │ http://attic.actions-...  │ Private cache  │
# └────────────────────────────────────────────────────────────────────────┘
#
# CUSTOMIZATION:
# To add a new binary cache:
# 1. Add URL to 'substituters' (space-separated)
# 2. Add public key to 'trusted-public-keys' (space-separated)
# 3. Apply: kubectl apply -f configmap.yaml
# 4. Restart nix-daemon: kubectl rollout restart ds/nix-daemon -n nix-csi
#
# =============================================================================

# -----------------------------------------------------------------------------
# Full Configuration (with Attic internal cache)
# Used by nix-daemon and nix-node pods in the cluster
# -----------------------------------------------------------------------------
apiVersion: v1
kind: ConfigMap
metadata:
  name: nix-csi-config
  namespace: nix-csi
  labels:
    app.kubernetes.io/name: nix-csi
    app.kubernetes.io/part-of: flakecache
data:
  nix.conf: |
    # Enable modern Nix commands (nix build, nix develop, nix flake)
    experimental-features = nix-command flakes

    # Binary caches - order matters, first is checked first
    # 1. Official NixOS cache (public, HTTPS)
    # 2. Cachix nix-community (community packages, devenv, etc.)
    # 3. Determinate Systems (nix tooling, installers)
    # 4. Attic cache (internal, HTTP - cluster-only)
    substituters = https://cache.nixos.org https://nix-community.cachix.org https://cache.determinate.systems http://attic.actions-runner-system.svc.cluster.local:8080/singularity

    # Public keys for signature verification
    # SECURITY: Only packages signed by these keys are accepted
    # - cache.nixos.org-1: Official NixOS cache
    # - nix-community.cachix.org-1: Cachix nix-community (devenv, home-manager, etc.)
    # - cache.determinate.systems-1: Determinate Systems (nix-installer, flakehub)
    # - singularity: Your Attic cache key (generated during attic-server setup)
    trusted-public-keys = cache.nixos.org-1:6NCHdD59X431o0gWypbMrAURkbJ16ZPMQFGspcDShjY= nix-community.cachix.org-1:mB9FSh9qf2dCimDSUo8Zy7bkq5CX+/rkCWyvRCYg3Fs= cache.determinate.systems-1:DaGv3H0FotMWgU9WTPW+LSVnmW4r40OWsE62aO8x2bI= singularity:nsWPgp0mIC/OZdqnm0UXSOblL37jAHny6zYhqyu6ckk=

    # CRITICAL: Require cryptographic signatures on all store paths
    # Setting to false would allow unsigned (potentially malicious) packages
    require-sigs = true

    # Build parallelism - auto = number of CPU cores
    max-jobs = auto

    # Keep build outputs for debugging/development
    keep-outputs = true

    # Let remote builders pull from caches (reduces transfer)
    builders-use-substitutes = true

---
# -----------------------------------------------------------------------------
# Minimal Configuration (public cache only)
# For environments without internal Attic cache
# -----------------------------------------------------------------------------
apiVersion: v1
kind: ConfigMap
metadata:
  name: nix-cache-config
  namespace: nix-csi
  labels:
    app.kubernetes.io/name: nix-csi
    app.kubernetes.io/part-of: flakecache
    app.kubernetes.io/component: minimal
data:
  nix.conf: |
    # Enable modern Nix commands
    experimental-features = nix-command flakes

    # Public NixOS cache only
    substituters = https://cache.nixos.org

    # Official NixOS cache key
    trusted-public-keys = cache.nixos.org-1:6NCHdD59X431o0gWypbMrAURkbJ16ZPMQFGspcDShjY=

    # Require signatures (always!)
    require-sigs = true

    # Parallel builds
    max-jobs = auto
