name: Sync media to S3

on:
  schedule:
    - cron: "0 3 * * *"
  workflow_dispatch:

jobs:
  sync:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: flakecache/nix-installer@v1.0.6

      - name: Sync media to S3
        env:
          INFISICAL_SERVICE_TOKEN: ${{ secrets.INFISICAL_SERVICE_TOKEN }}
          INFISICAL_API_URL: https://vault.singularity-engine.com/api
        run: |
          set -euo pipefail
          # Pull secrets from Infisical and run the Nix-defined sync-media app
          nix shell nixpkgs#infisical -c infisical run \
            --env prod \
            --path /ogt-web \
            --domain "${INFISICAL_API_URL}" \
            --token "${INFISICAL_SERVICE_TOKEN}" \
            -- nix run .#sync-media
